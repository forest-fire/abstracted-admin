{"version":3,"file":"abstracted-admin.cjs.js","sources":["esnext/db.js"],"sourcesContent":["import * as firebase from \"firebase-admin\";\nimport * as process from \"process\";\nimport { RealTimeDB, _getFirebaseType } from \"abstracted-firebase\";\nexport class DB extends RealTimeDB {\n    constructor(config) {\n        super();\n        config = Object.assign({\n            name: \"[default]\"\n        }, config);\n        this.initialize(config);\n    }\n    get auth() {\n        return _getFirebaseType(this, \"auth\");\n    }\n    get firestore() {\n        return _getFirebaseType(this, \"firestore\");\n    }\n    get database() {\n        return _getFirebaseType(this, \"database\");\n    }\n    get messaging() {\n        return _getFirebaseType(this, \"messaging\");\n    }\n    get storage() {\n        return _getFirebaseType(this, \"storage\");\n    }\n    async connectToFirebase(config) {\n        if (!this._isAuthorized) {\n            const serviceAcctEncoded = config.serviceAccount || process.env[\"FIREBASE_SERVICE_ACCOUNT\"];\n            if (!serviceAcctEncoded) {\n                throw new Error(\"Problem loading the credientials for Firebase admin API. Please ensure FIREBASE_SERVICE_ACCOUNT is set with base64 encoded version of Firebase private key.\");\n            }\n            const serviceAccount = JSON.parse(Buffer.from(process.env[\"FIREBASE_SERVICE_ACCOUNT\"], \"base64\").toString());\n            console.log(`Connecting to Firebase: [${process.env[\"FIREBASE_DATA_ROOT_URL\"]}]`);\n            try {\n                firebase.initializeApp({\n                    credential: firebase.credential.cert(serviceAccount),\n                    databaseURL: config.databaseUrl || process.env[\"FIREBASE_DATA_ROOT_URL\"]\n                });\n                this._isAuthorized = true;\n                this._database = firebase.database();\n                firebase.database().goOnline();\n                firebase\n                    .database()\n                    .ref(\".info/connected\")\n                    .on(\"value\", snap => {\n                    this._isConnected = snap.val();\n                    // cycle through temporary clients\n                    this._waitingForConnection.forEach(cb => cb());\n                    this._waitingForConnection = [];\n                    // call active listeners\n                    if (this.isConnected) {\n                        this._onConnected.forEach(listener => listener.cb(this));\n                    }\n                    else {\n                        this._onDisconnected.forEach(listener => listener.cb(this));\n                    }\n                });\n            }\n            catch (err) {\n                if (err.message.indexOf(\"The default Firebase app already exists.\") !== -1) {\n                    console.warn(\"DB was already logged in, however flag had not been set!\");\n                    this._isConnected = true;\n                }\n                else {\n                    this._isConnected = false;\n                    console.warn(\"Problem connecting to Firebase\", err);\n                    throw new Error(err);\n                }\n            }\n        }\n        // if (config.debugging) {\n        //   firebase.database.enableLogging(\n        //     typeof config.debugging === \"function\"\n        //       ? (message: string) => config.debugging(message)\n        //       : (message: string) => console.log(\"[FIREBASE]\", message)\n        //   );\n        // }\n    }\n    /**\n     * listenForConnectionStatus\n     *\n     * in the admin interface we assume that ONCE connected\n     * we remain connected; this is unlike the client API\n     * which provides an endpoint to lookup\n     */\n    async listenForConnectionStatus() {\n        return new Promise(resolve => {\n            const cb = () => {\n                resolve();\n            };\n            this._waitingForConnection.push(cb);\n        });\n    }\n}\n"],"names":["RealTimeDB","_getFirebaseType","process.env","firebase.initializeApp","firebase.credential","firebase.database","firebase\n                    .database"],"mappings":"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"}