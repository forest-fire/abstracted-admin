{"version":3,"file":"abstracted-admin.umd.js","sources":["esnext/db.js"],"sourcesContent":["import * as firebase from \"firebase-admin\";\nimport * as process from \"process\";\nimport { RealTimeDB } from \"abstracted-firebase\";\nexport class DB extends RealTimeDB {\n    constructor(config = {}) {\n        super(config);\n        if (!config.mocking) {\n            this.connect(config.debugging);\n            RealTimeDB.connection = firebase.database();\n            firebase.database().goOnline();\n            firebase\n                .database()\n                .ref(\".info/connected\")\n                .on(\"value\", snap => {\n                DB.isConnected = snap.val();\n                // cycle through temporary clients\n                this._waitingForConnection.forEach(cb => cb());\n                this._waitingForConnection = [];\n                // call active listeners\n                if (DB.isConnected) {\n                    this._onConnected.forEach(listener => listener.cb(this));\n                }\n                else {\n                    this._onDisconnected.forEach(listener => listener.cb(this));\n                }\n            });\n        }\n    }\n    async waitForConnection() {\n        if (DB.isConnected) {\n            return Promise.resolve();\n        }\n        return new Promise(resolve => {\n            const cb = () => {\n                resolve();\n            };\n            this._waitingForConnection.push(cb);\n        });\n    }\n    get isConnected() {\n        return DB.isConnected;\n    }\n    connect(debugging = false) {\n        if (!DB.isAuthorized) {\n            const serviceAcctEncoded = process.env[\"FIREBASE_SERVICE_ACCOUNT\"];\n            if (!serviceAcctEncoded) {\n                throw new Error(\"Problem loading the credientials for Firebase admin API. Please ensure FIREBASE_SERVICE_ACCOUNT is set with base64 encoded version of Firebase private key.\");\n            }\n            const serviceAccount = JSON.parse(Buffer.from(process.env[\"FIREBASE_SERVICE_ACCOUNT\"], \"base64\").toString());\n            console.log(`Connecting to Firebase: [${process.env[\"FIREBASE_DATA_ROOT_URL\"]}]`);\n            try {\n                firebase.initializeApp({\n                    credential: firebase.credential.cert(serviceAccount),\n                    databaseURL: process.env[\"FIREBASE_DATA_ROOT_URL\"]\n                });\n                DB.isAuthorized = true;\n            }\n            catch (err) {\n                if (err.message.indexOf(\"The default Firebase app already exists.\") !== -1) {\n                    console.warn(\"DB was already logged in, however flag had not been set!\");\n                    DB.isConnected = true;\n                }\n                else {\n                    DB.isConnected = false;\n                    console.warn(\"Problem connecting to Firebase\", err);\n                    throw new Error(err);\n                }\n            }\n        }\n        if (debugging) {\n            firebase.database.enableLogging(typeof debugging === \"function\"\n                ? (message) => debugging(message)\n                : (message) => console.log(\"[FIREBASE]\", message));\n        }\n    }\n}\n"],"names":["RealTimeDB","firebase.database","firebase\n                .database","process.env","firebase.initializeApp","firebase.credential"],"mappings":"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"}